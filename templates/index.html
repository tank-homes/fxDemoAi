<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX 自動売買デモ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            padding: 0;
        }

        h2, h3 {
            text-align: center;
        }

       #control-panel {
            width: 100%;
            max-width: 420px;  /* PCでは幅を制限 */
            padding: 15px;
            border: 1px solid #ccc;
            background: #f7f7f7;
            box-sizing: border-box;
        }

        #control-panel label {
            display: block;
            margin-bottom: 10px;
        }

        input, button {
            width: 100%;
            box-sizing: border-box;
            margin-top: 5px;
            margin-bottom: 10px;
            padding: 8px;
            font-size: 1em;
        }

        canvas {
            width: 100%;
            height: auto;
            max-height: 300px; /* 高さを控えめに */
        }

        table {
            width: 100%;
            font-size: 0.9em;
            overflow-x: auto;
            display: block;
        }

        td, th {
            border: 1px solid #aaa;
            padding: 5px 10px;
            text-align: center;
            white-space: nowrap;
        }

        @media (max-width: 600px) {
            #control-panel {
                width: 95%;
                padding: 10px;
            }
            table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<h2>FX 自動売買（3分間）</h2>

<div id="control-panel">
    <label>通貨ペア（例：USDJPY=X, GBPJPY=X）
        <input type="text" id="pair" value="GBPJPY=X">
    </label>

    <label>初期残高
        <input type="number" id="initial_balance" value="10000">
    </label>

    <label>買い閾値（予測価格 ÷ 現在価格、1以上の数値を入力。1.0に近い程積極的に買う）
        <input type="number" step="0.001" id="buy_threshold" value="1.002">
    </label>

    <label>売り閾値（予測価格 ÷ 現在価格、1未満の数値を入力。1.0に近い程積極的に売る）
        <input type="number" step="0.001" id="sell_threshold" value="0.998">
    </label>

    <button onclick="startTrade()">自動売買スタート</button>
</div>

<canvas id="priceChart"></canvas>

<h3>取引ログ</h3>

<table>
    <thead>
        <tr>
            <th>時間</th>
            <th>価格</th>
            <th>予測</th>
            <th>アクション</th>
            <th>残高</th>
            <th>ポジション</th>
            <th>総資産</th>
        </tr>
    </thead>
    <tbody id="trade-log"></tbody>
</table>

<script>
let ws;
let priceChart;
let priceData = [];
let labels = [];

function startTrade() {
    if (ws) ws.close();

    const wsUrl = location.protocol === "https:" 
        ? "wss://" + location.host + "/ws/auto_trade"
        : "ws://" + location.host + "/ws/auto_trade";

    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        ws.send(JSON.stringify({
            pair: document.getElementById("pair").value,
            initial_balance: document.getElementById("initial_balance").value,
            buy_threshold: document.getElementById("buy_threshold").value,
            sell_threshold: document.getElementById("sell_threshold").value
        }));
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.error) {
            alert(data.error);
            return;
        }

        labels.push(data.time);
        priceData.push(data.price);
        if (labels.length > 50) {
            labels.shift();
            priceData.shift();
        }
        priceChart.update();

        const row = `
            <tr>
                <td>${data.time}</td>
                <td>${data.price.toFixed(3)}</td>
                <td>${data.predicted.toFixed(3)}</td>
                <td>${data.action}</td>
                <td>${data.balance.toFixed(2)}</td>
                <td>${data.position.toFixed(4)}</td>
                <td>${data.total_assets.toFixed(2)}</td>
            </tr>
        `;
        document.getElementById("trade-log").insertAdjacentHTML("afterbegin", row);
    };

    initChart();
}

function initChart() {
    const ctx = document.getElementById("priceChart").getContext("2d");

    priceChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "価格",
                data: priceData,
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // 高さを自動調整
            animation: false,
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
}
</script>

</body>
</html>
